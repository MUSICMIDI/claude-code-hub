version: '3.8'

services:
  postgres:
    image: postgres:16-alpine
    container_name: claude-hub-db
    environment:
      POSTGRES_USER: claude
      POSTGRES_PASSWORD: dev123456
      POSTGRES_DB: claude_hub
    ports:
      - "5432:5432"
    volumes:
      # 持久化数据库数据到本地 ./data/postgres 目录
      # 重建容器不会丢失数据,可直接备份此目录
      - ./data/postgres:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U claude"]
      interval: 5s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: claude-hub-redis
    ports:
      - "6379:6379"
    volumes:
      # 持久化 Redis 数据到本地 ./data/redis 目录
      # 使用 AOF 持久化模式,确保数据不丢失
      - ./data/redis:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  app:
    build:
      context: .
      dockerfile: deploy/Dockerfile
      args:
        APP_VERSION: ${APP_VERSION:-dev}
    container_name: claude-hub-app
    environment:
      NODE_ENV: production
      DSN: postgres://claude:dev123456@postgres:5432/claude_hub
      ADMIN_TOKEN: ${ADMIN_TOKEN:-local-dev-token-change-in-production}
      AUTO_MIGRATE: "true"
      DEBUG_MODE: "true"
      PORT: 3000
    ports:
      - "13500:3000"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped

# volumes 配置已移除,改用本地目录映射
# 数据存储在 ./data/postgres 和 ./data/redis 目录
# 请确保 ./data 目录已添加到 .gitignore 中
